#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

START_MESSAGE="-----> Follow symlinks to actual files buildpack"

if [ -f $ENV_DIR/PROJECT_PATH ]; then
	PROJECT_PATH=`cat $ENV_DIR/PROJECT_PATH`
	if [ -d $BUILD_DIR/$PROJECT_PATH ]; then
	  echo "$START_MESSAGE in $PROJECT_PATH"
	  cd $BUILD_DIR/$PROJECT_PATH
  else
    echo $START_MESSAGE
    cd $BUILD_DIR
  fi
else
  echo $START_MESSAGE
  cd $BUILD_DIR
fi

SYMBOLIC_LINKS=$(git ls-files | xargs -IXXX find XXX -type l)
echo $SYMBOLIC_LINKS

for f in $SYMBOLIC_LINKS; do
  DEST=$(echo ${f})
  SRC=$(./scripts/greadlink ${f})
  unlink ${DEST}
  echo $SRC
  echo $DEST
  cp -r ${SRC} ${DEST}
done

exit 0
